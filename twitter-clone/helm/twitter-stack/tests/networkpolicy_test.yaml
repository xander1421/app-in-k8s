# helm unittest - NetworkPolicy Tests
suite: networkpolicy tests
templates:
  - templates/networkpolicy.yaml
tests:
  # ==========================================================================
  # BASIC NETWORKPOLICY TESTS
  # ==========================================================================
  - it: should create NetworkPolicy when enabled
    asserts:
      - isKind:
          of: NetworkPolicy
      - equal:
          path: metadata.name
          value: goapp-goapp-network-policy

  - it: should not create NetworkPolicy when disabled
    set:
      networkPolicy:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  # ==========================================================================
  # POLICY TYPE TESTS
  # ==========================================================================
  - it: should have both Ingress and Egress policy types
    asserts:
      - contains:
          path: spec.policyTypes
          content: Ingress
      - contains:
          path: spec.policyTypes
          content: Egress

  # ==========================================================================
  # INGRESS RULES TESTS
  # ==========================================================================
  - it: should allow ingress from envoy-gateway-system namespace
    asserts:
      - exists:
          path: spec.ingress

  - it: should allow ingress on app port
    asserts:
      - contains:
          path: spec.ingress[0].ports
          content:
            protocol: TCP
            port: 3000
          any: true

  # ==========================================================================
  # EGRESS RULES TESTS
  # ==========================================================================
  - it: should allow DNS egress (port 53)
    asserts:
      - exists:
          path: spec.egress

  - it: should allow egress to PostgreSQL when enabled
    set:
      postgresql:
        enabled: true
    asserts:
      - exists:
          path: spec.egress

  - it: should allow egress to Redis when enabled
    set:
      redis:
        enabled: true
    asserts:
      - exists:
          path: spec.egress

  - it: should allow egress to Elasticsearch when enabled
    set:
      elasticsearch:
        enabled: true
    asserts:
      - exists:
          path: spec.egress

  - it: should allow egress to RabbitMQ when enabled
    set:
      rabbitmq:
        enabled: true
    asserts:
      - exists:
          path: spec.egress

  # ==========================================================================
  # POD SELECTOR TESTS
  # ==========================================================================
  - it: should select fileshare pods
    asserts:
      - equal:
          path: spec.podSelector.matchLabels.app
          value: fileshare
